<!DOCTYPE html>
<html>
<head>
    <title>Interview Practice Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body {
            background: #f7f9fc;
            font-family: "Segoe UI", sans-serif;
            padding: 40px;
            text-align: center;
        }
        .container {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: inline-block;
            width: 70%;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 10px;
            resize: none;
        }
        select, button {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin: 10px;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>

    <h2>Welcome, {{ current_user.username }}</h2>

    <div class="container">
        <form method="POST">
            <label for="role">Choose a role:</label>
            <select name="role">
                {% for role in roles %}
                    <option value="{{ role }}" {% if role == selected_role %}selected{% endif %}>{{ role }}</option>
                {% endfor %}
            </select>
            <button type="submit" name="next_question">Next Question üîÑ</button>

            <h3 style="margin-top:20px;">Interview Question:</h3>
            <p><strong>{{ question }}</strong></p>

            <textarea name="answer" id="answerBox" placeholder="Type or record your answer here..."></textarea>
            <br>
            <button type="button" id="recordBtn">üé§ Record Answer</button>
            <p id="recordStatus"></p>

            <br>
            <button type="submit" name="submit_answer">Submit Answer ‚úÖ</button>
        </form>

        {% if feedback %}
            <div style="margin-top:20px;">
                <h4>AI Feedback:</h4>
                <p>{{ feedback }}</p>
                <p><strong>Score:</strong> {{ score }}/3</p>
            </div>
        {% endif %}
    </div>

    <p style="margin-top: 30px;">
        <a href="/dashboard">üìä View Dashboard</a> |
        <!-- <a href="/voice_analytics">üé§ Voice Analytics</a> -->|
        <a href="/logout" style="color:red;">üö™ Logout</a>
    </p>

<script>
let mediaRecorder;
let audioChunks = [];
const recordBtn = document.getElementById("recordBtn");
const status = document.getElementById("recordStatus");

recordBtn.onclick = async () => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.start();
        status.innerText = "üéôÔ∏è Recording... click again to stop.";
        recordBtn.innerText = "‚èπÔ∏è Stop Recording";

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
            const blob = new Blob(audioChunks, { type: "audio/webm" });
            const file = new File([blob], "voice_answer.webm");
            const formData = new FormData();
            formData.append("voice", file);

            status.innerText = "‚è≥ Processing your voice...";
            const response = await fetch("/voice_answer", { method: "POST", body: formData });
            const data = await response.json();

            if (data.transcribed_text) {
                document.getElementById("answerBox").value = data.transcribed_text;
                status.innerText = "‚úÖ Voice converted to text ‚Äî you can edit before submitting.";
            } else {
                status.innerText = "‚ùå Transcription failed.";
            }
        };

        mediaRecorder.start();
    } else {
        mediaRecorder.stop();
        recordBtn.innerText = "üé§ Record Again";
        status.innerText = "Processing...";
    }
};
</script>

</body>
</html>
